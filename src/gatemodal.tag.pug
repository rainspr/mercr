gatemodal
  .modal(role="dialog", id="{ opts.modid }")
    .modal-dialog
      .modal-content(class="{ opts.modcolor }")
        .modal-header.panel-heading
          button(type="button", data-dismiss="modal").close &times;
          h4.modal-title { opts.modtitle }: { modalobj.prayed } ({ modalobj.minupdated })
        .modal-body
          form(ref="formref", onsubmit="return false;")
            fieldset.form-group
              label.radio-inline(each="{ elem }") #[input(type="radio", name="elemradio", value="{ value }", onchange="{ setfilter }")] { text }
            fieldset.form-group
              label.radio-inline(each="{ isgate }") #[input(type="radio", name="gateradio", value="{ value }", onchange="{ setfilter }")] { text }
            fieldset.form-group
              select.form-control(name="seedselect")
            fieldset.form-group
              select.form-control(name="digitselect")
            fieldset.form-group
              .row
                .col-xs-6
                  select.form-control(name="sizeselect", onchange="{ setval }")
                    option(each="{ size }", value="{ value }") { text }
                //.col-xs-6
                  select.form-control(name="waveselect", onchange="{ setval }")
                    option(each="{ wave }", value="{ value }") { text }

  script.
    var self = this
    var seedselectized = []
    var digitselectized = []
    self.modalobj = {
      elemradio: "all",
      gateradio: false,
      seedselect: [],
      selected: [],
      digitselect: "0",
      sizeselect: "1.72",
      waveselect: "1.0",
      prayed: "-%",
      minupdated: "-分"
    }
    self.seeddef = seed.map(function(obj) {
      obj.extname += obj.name + convertToHira(obj.name)
      obj.elm += "all"
      return obj
    })
    setfilter(e) {
      self.modalobj[e.target.name] = e.target.value
      filterseed()
    }
    setval(e) {
      self.modalobj[e.target.name] = e.target.value
      calc()
    }
    function calc() {
      self.modalobj.selected = setseedmulti(self.modalobj.seedselect)
      obs.trigger('onselect', self.modalobj.selected)
      self.modalobj.prayed = objfirsttopray(self.modalobj) + "%"
      self.modalobj.minupdated = self.parent.clockmin
      self.update()
      obs.trigger('oncalc', opts.refname)
    }
    function convertToHira(str) {
      return str.replace(/[\u30a1-\u30f6]/g, function (match) {
        var chr = match.charCodeAt(0) - 0x60
        return String.fromCharCode(chr)
      })
    }
    function setseedmulti(seedname) {
      var arr = []
      for(var l=0; l<seedname.length; l++) {
        var obj = self.seeddef.filter(function(seed,index) {
          if(seed.name === seedname[l]) return true
        })
        if(obj) {
          arr[l] = obj[0]
        }
      }
      if(arr) {
        return arr
      }
    }
    function praycalc(seedhp,seedsize,inputhp,scale,wave) {
      return Math.round((inputhp / (seedhp/seedsize*scale) -1) * 100 / wave)
    }
    function objfirsttopray(obj) {
      var seedhp = obj.selected[0].hp
      var seedsize = obj.selected[0].size
      var inputhp = Number(obj.digitselect)
      var scale = Number(obj.sizeselect)
      var wave = Number(obj.waveselect)
      return praycalc(seedhp,seedsize,inputhp,scale,wave).toLocaleString()
    }
    function filterseed() {
      self.seedfil = self.seeddef.filter(function(seed,index) {
        if((seed.elm).indexOf(self.modalobj.elemradio) >= 0) {
          if(self.modalobj.gateradio === "true") {
            if(seed.gate === true) return true
          } else return true
        }
      })
      seedselectized[0].selectize.clearOptions()
      seedselectized[0].selectize.addOption(self.seedfil)
      seedselectized[0].selectize.refreshOptions()
    }
    self.elem = [
      { text: "すべて", value: "all", checked: true },
      { text: "炎", value: "fire", checked: false },
      { text: "水", value: "water", checked: false },
      { text: "風", value: "wind", checked: false },
      { text: "光", value: "light", checked: false },
      { text: "闇", value: "dark", checked: false }
    ]
    self.isgate = [
      { text: "すべて", value: false, checked: true },
      { text: "ゲートから出るもののみ", value: true, checked: false }
    ]
    self.size = [
      { text: "1.72", value: 1.72 },
      { text: "1.75", value: 1.75 },
      { text: "1.80", value: 1.80 },
      { text: "1.00", value: 1.00 }
    ]
    self.wave = [
      { text: "1体目", value: 1.0 },
      { text: "2体目", value: 1.2 },
      { text: "3体目", value: 1.4 },
      { text: "4体目", value: 1.6 },
      { text: "5体目", value: 1.8 }
    ]
    self.on('mount', function() {
      self.refs.formref.elemradio.value = "all"
      self.refs.formref.gateradio.value = "false"
      self.seedfil = self.seeddef

      $(function(){
        seedselectized = $(self.refs.formref.seedselect).selectize({
          options: self.seedfil,
          valueField: "name",
          labelField: "name",
          searchField: ["extname"],
          maxItems: 5,
          placeholder: "5体選べます"
        })
        digitselectized = $(self.refs.formref.digitselect).selectize({
          options: [],
          valueField: "value",
          labelField: "text",
          searchField: ["value"],
          placeholder: "1体目の体力",
          load: function(query, callback) {
            if(!query.length) return callback()
            function expanddigit(val,dig) {
              return val * Math.pow(10, dig - String(val).length)
            }
            query = Number(query)
            callback([
              { text: expanddigit(query, 6).toLocaleString(), value: expanddigit(query, 6) },
              { text: expanddigit(query, 7).toLocaleString(), value: expanddigit(query, 7) },
              { text: expanddigit(query, 8).toLocaleString(), value: expanddigit(query, 8) },
              { text: expanddigit(query, 9).toLocaleString(), value: expanddigit(query, 9) },
              { text: expanddigit(query, 10).toLocaleString(), value: expanddigit(query, 10) }
            ])
          }
        })
        seedselectized.on('change', function(){
          self.modalobj.seedselect = seedselectized.val()
          calc()
        })
        digitselectized.on('change', function(){
          self.modalobj.digitselect = this.value
          calc()
        })
      })
    })

  style.
    .panel-heading {
      border-top-left-radius: inherit;
      border-top-right-radius: inherit;
    }
